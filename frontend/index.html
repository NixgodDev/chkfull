const form = document.getElementById('testar-cartoes');
const aprovadosDiv = document.getElementById('aprovados');
const reprovadosDiv = document.getElementById('reprovados');
const errosDiv = document.getElementById('erros');

form.addEventListener('submit', async (event) => {
  event.preventDefault();

  const cartoes = document.getElementById('cartoes').value;

  // Limpa os resultados anteriores
  aprovadosDiv.innerHTML = '';
  reprovadosDiv.innerHTML = '';
  errosDiv.innerHTML = '';

  try {
    const response = await fetch('/verificar-3ds', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ cartoes }),
    });

    // Verifica se a resposta é válida
    if (!response.ok) {
      throw new Error(`Erro na requisição: ${response.status} ${response.statusText}`);
    }

    // Tenta processar a resposta como JSON
    const data = await response.json();

    if (data.success) {
      // Filtra os resultados
      const aprovados = data.resultados.filter((resultado) => resultado.status === 'Cadastrado no 3D Secure');
      const reprovados = data.resultados.filter((resultado) => resultado.status === 'Não cadastrado no 3D Secure');
      const erros = data.resultados.filter((resultado) => resultado.status.startsWith('Erro ao verificar'));

      // Exibe os aprovados
      if (aprovados.length > 0) {
        aprovadosDiv.innerHTML = '<h2>Cartões Aprovados:</h2>';
        aprovados.forEach((resultado) => {
          aprovadosDiv.innerHTML += `<p><strong>Cartão:</strong> ${resultado.cartao} | <strong>Status:</strong> ${resultado.status}</p>`;
        });
      } else {
        aprovadosDiv.innerHTML = '<p>Nenhum cartão aprovado.</p>';
      }

      // Exibe os reprovados
      if (reprovados.length > 0) {
        reprovadosDiv.innerHTML = '<h2>Cartões Reprovados:</h2>';
        reprovados.forEach((resultado) => {
          reprovadosDiv.innerHTML += `<p><strong>Cartão:</strong> ${resultado.cartao} | <strong>Status:</strong> ${resultado.status}</p>`;
        });
      } else {
        reprovadosDiv.innerHTML = '<p>Nenhum cartão reprovado.</p>';
      }

      // Exibe os erros
      if (erros.length > 0) {
        errosDiv.innerHTML = '<h2>Erros:</h2>';
        erros.forEach((resultado) => {
          errosDiv.innerHTML += `<p><strong>Cartão:</strong> ${resultado.cartao} | <strong>Erro:</strong> ${resultado.status}</p>`;
        });
      } else {
        errosDiv.innerHTML = '<p>Nenhum erro encontrado.</p>';
      }
    } else {
      errosDiv.innerHTML = `<p style="color: red;">Erro: ${data.message}</p>`;
    }
  } catch (error) {
    errosDiv.innerHTML = `<p style="color: red;">Erro ao enviar requisição: ${error.message}</p>`;
  }
});
